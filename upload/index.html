<!DOCTYPE html>
<html lang="en">
<head>
  <title>Upload your LPRC Tag-A-Tiny tagging card</title>
  <meta name="description" content="LPRC Tag-A-Tiny card upload"/>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/blocks@0.39.0/web/lr-file-uploader-minimal.min.css">
  <link rel="stylesheet" href="./styles.css">
</head>

<body>

  <p>
    <a href="https://tunalab.org/tagatiny.htm">← Large Pelagics Research Center</a>
  </p>

  <h1>Tag-A-Tiny tagging card online submission</h1>
  <h2 style="color:SteelBlue;font-family:Arial"><i>Send us your tagging card (and any other pictures you want) by clicking "Choose file" below</i></h2>
  <p><i>Note</i>: We only support uploading a single image (< 10 Mb). You will see a preview when an upload is completed. </p>
  <p> Please click "+" to add more pictures that you may want to send us, thanks!</p>
  <hr>

  <lr-config
    ctx-name="my-uploader"
    pubkey="a66258374342dbd6a25c"
  ></lr-config>
  <lr-file-uploader-minimal
    ctx-name="my-uploader"
  ></lr-file-uploader-minimal>
  <lr-upload-ctx-provider
    ctx-name="my-uploader"
    id="my-uploader-provider"
  ></lr-upload-ctx-provider>

  <div class="previews" id="previews"></div>

  <script type="module">
    import * as LR from 'https://cdn.jsdelivr.net/npm/@uploadcare/blocks@0.39.0/web/lr-file-uploader-minimal.min.js';

    LR.registerBlocks(LR);

    const providerNode = document.getElementById('my-uploader-provider');
    const previewsNode = document.getElementById('previews');

    providerNode.addEventListener('change', handleChangeEvent);

    function handleChangeEvent(e) {
      console.log('change event payload:', e);
      // Display preview below
      renderFiles(e.detail.allEntries.filter(f => f.status === 'success'));
      // List file names
      listFiles(e.detail.allEntries.filter(f => f.status === 'success'));
      // List unique URLs
      listFiles2(e.detail.allEntries.filter(f => f.status === 'success'));
    }

    function renderFiles(files) {
      const renderedFiles = files.map(file => {

        // Original code
        const fileNode = document.createElement('div');
        fileNode.setAttribute('class', 'preview-wrapper');

        const imgNode = document.createElement('img');
        imgNode.setAttribute('class', 'preview-image');
        imgNode.setAttribute('src', file.cdnUrl + '/-/preview/-/resize/x400/');
        imgNode.setAttribute('width','200');
        imgNode.setAttribute('height','200');
        imgNode.setAttribute('alt', file.fileInfo.originalFilename);
        imgNode.setAttribute('title', file.fileInfo.originalFilename);

        const imgNameNode = document.createElement('p');
        imgNameNode.setAttribute('class', 'preview-data');
        imgNameNode.textContent = `${file.fileInfo.originalFilename}`;

        const imgSizeNode = document.createElement('p');
        imgSizeNode.setAttribute('class', 'preview-data');
        imgSizeNode.textContent = `${formatSize(file.fileInfo.size)}`;

        fileNode.append(imgNode, imgNameNode, imgSizeNode);

        return fileNode;
      });
      // Show preview
      previewsNode.replaceChildren(...renderedFiles);
    }

    function listFiles(files) {
      var lfiles = "";
      const listedFiles = files.map(file => {
        lfiles = lfiles + ";" + file.fileInfo.originalFilename;
        return lfiles;
      });
      // Do something
      document.getElementById("frmFiles").value = lfiles.substring(1);
    }

    function listFiles2(files) {
      var lfiles = "";
      const listedFiles = files.map(file => {
        lfiles = lfiles + ";" + file.cdnUrl;
        return lfiles;
      });
      // Do something
      document.getElementById("frmUrls").value = lfiles.substring(1);
    }

    function formatSize(bytes) {
      if (!bytes) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return `${parseFloat((bytes / k ** i).toFixed(2))} ${sizes[i]}`;
    }

  </script>

  <h3>Please share (at a minimum) your contact email/ phone number </h3>
  <h4 style="color:SlateGray"><i>... just in case we need to ask you a quick question, thanks!</i></h4>
  <form action="https://docs.google.com/forms/d/e/1FAIpQLSdL_Rx1HiLS5QdtVfhn6Y9gv2-JCySZfJSpwjreq8ONpEwMRw/formResponse" method="POST">
    <label>Name:</label><br>
    <input type="text" name="entry.948710931"><br>
    <label>Phone:</label><br>
    <input type="text" name="entry.961002918"><br>
    <label>Email:</label><br>
    <input type="text" name="entry.2091453718"><br>
    <input id="frmFiles" type="hidden" name="entry.1037652762">
    <input id="frmUrls" type="hidden" name="entry.1061286133">
    <br>
    <input type="submit" value="Submit">
  </form>

  <hr>
  <p>© Large Pelagics Research Center. Gloucester, MA 01930.  All Rights Reserved. </p>

</body>
</html>
